# 模型切换指南

## 概述

系统支持通过环境变量配置视觉模型，当主模型不可用时自动切换到备用模型，确保服务连续性。

## 配置方法

### 1. 环境变量配置

在 `.env.local` 文件中配置模型：

```bash
# 主视觉模型（默认）
VISION_MODEL=doubao-seed-1-6-vision-250815

# 备用视觉模型（主模型失败时自动切换）
FALLBACK_VISION_MODEL=doubao-seed-1-8-251228
```

### 2. 可用的豆包视觉模型

| 模型ID | 类型 | 说明 |
|--------|------|------|
| `doubao-seed-1-6-vision-250815` | 专用视觉模型 | 专为图像识别优化，当前默认 |
| `doubao-seed-1-8-251228` | 多模态Agent | 支持视觉，推荐作为备用 |
| `doubao-seed-1-6-251015` | 平衡性能模型 | 支持多模态，可作为备选 |

## 模型切换机制

### 自动切换流程

```
用户上传图片
    ↓
调用主模型 (VISION_MODEL)
    ↓
成功？→ 返回结果
    ↓ 失败
记录错误日志
    ↓
尝试备用模型 (FALLBACK_VISION_MODEL)
    ↓
成功？→ 返回结果 + "备用模型切换成功" 日志
    ↓ 失败
返回错误：主模型和备用模型均调用失败
```

### 日志输出示例

**成功使用主模型：**
```
============================================================
🎯 和弦识别任务启动
📐 图片尺寸: 1920 x 1080
🤖 主模型配置: doubao-seed-1-6-vision-250815
🔄 备用模型配置: doubao-seed-1-8-251228
============================================================
🤖 调用主模型: doubao-seed-1-6-vision-250815
✅ 主模型调用成功: doubao-seed-1-6-vision-250815
🎯 实际使用的模型: doubao-seed-1-6-vision-250815
```

**自动切换到备用模型：**
```
============================================================
🎯 和弦识别任务启动
📐 图片尺寸: 1920 x 1080
🤖 主模型配置: doubao-seed-1-6-vision-250815
🔄 备用模型配置: doubao-seed-1-8-251228
============================================================
🤖 调用主模型: doubao-seed-1-6-vision-250815
❌ 主模型调用失败 (doubao-seed-1-6-vision-250815): Model not available
⚠️ 主模型 doubao-seed-1-6-vision-250815 调用失败，尝试备用模型 doubao-seed-1-8-251228
🤖 调用备用模型: doubao-seed-1-8-251228
✅ 备用模型调用成功: doubao-seed-1-8-251228
✅ 备用模型切换成功
🎯 实际使用的模型: doubao-seed-1-8-251228
```

## 快速切换模型

### 场景1：主模型即将停止服务

```bash
# 编辑 .env.local
VISION_MODEL=doubao-seed-1-8-251228
FALLBACK_VISION_MODEL=doubao-seed-1-6-251015
```

### 场景2：临时测试新模型

```bash
# 临时设置（不修改 .env.local）
export VISION_MODEL=doubao-seed-1-8-251228
```

### 场景3：部署环境切换

在 Vercel 部署时，直接在项目设置中添加环境变量：
- `VISION_MODEL`: 指定主模型
- `FALLBACK_VISION_MODEL`: 指定备用模型

## 一致性保障

### 提示词设计
- 使用绝对像素坐标系统
- 明确的识别规则和返回格式
- 固定温度参数（temperature=0.2）

### 后处理机制
- OCR修正库校对升降号
- 去重算法（1%距离阈值）
- 异常值检测（±3标准差）

### 数据复用
- 同一图片只识别一次
- 调整字号/颜色时复用原数据
- 避免模型切换导致的差异

## 监控与调试

### 查看使用的模型

返回结果包含 `_modelUsed` 字段：

```json
{
  "key": "C",
  "centers": [...],
  "_modelUsed": "doubao-seed-1-8-251228"
}
```

### 错误处理

所有错误都会记录详细日志：
- 主模型失败原因
- 备用模型调用状态
- 最终失败原因（如果都失败）

## 注意事项

1. **不要频繁切换模型**：每次切换都会重新识别，可能产生微小差异
2. **备用模型能力**：确保备用模型支持视觉功能
3. **日志监控**：定期检查日志中的模型使用情况
4. **环境变量优先级**：.env.local > 默认值

## 故障排查

### 问题：主模型和备用模型都失败

**可能原因：**
- API密钥配置错误
- 网络连接问题
- 模型服务不可用

**解决方法：**
1. 检查 `.env.local` 配置
2. 查看 Docker/服务器日志
3. 验证 API 密钥是否有效
4. 尝试其他可用模型

### 问题：模型切换后识别结果不一致

**可能原因：**
- 不同模型的识别能力差异
- 提示词对某些模型不够明确

**解决方法：**
1. 对比两组识别结果
2. 根据实际情况微调提示词
3. 使用数据复用机制（避免重复识别）

## 最佳实践

1. **提前准备**：在模型停止服务前完成切换
2. **测试验证**：切换后先测试几张图片
3. **监控日志**：关注模型使用情况和错误率
4. **备份配置**：保留可用的模型配置作为后备
5. **渐进切换**：先切换10%流量，观察效果后再全量
