# 模型切换指南

## 概述

系统支持通过环境变量配置视觉模型，并采用**配置化的智能模型选择机制**。每个模型都明确定义了类型和优先级，系统会自动从可用模型列表中选择最佳备用模型，优先选择**纯视觉模型**以保证识别准确性。

## 配置化的模型管理

### 模型配置结构

每个模型都配置了以下属性：

```typescript
interface VisionModelConfig {
  id: string;      // 模型ID
  name: string;    // 模型名称
  type: 'pure-vision' | 'multimodal';  // 模型类型
  priority: number; // 优先级
}
```

### 可用的视觉模型配置

| 模型ID | 名称 | 类型 | 优先级 | 说明 |
|--------|------|------|--------|------|
| `doubao-seed-1-6-vision-250815` | 纯视觉模型 | pure-vision | 1 | 专为图像识别优化，推荐 |
| `doubao-seed-1-8-251228` | 多模态Agent | multimodal | 2 | 支持视觉，推荐作为备用 |

**优势：**
- ✅ **非硬编码**：模型属性通过配置定义，易于维护
- ✅ **灵活扩展**：添加新模型只需在配置列表中添加
- ✅ **类型安全**：TypeScript 类型检查确保正确性
- ✅ **易于理解**：模型信息一目了然

## 智能模型选择机制

### 模型优先级

系统根据模型类型和名称自动排序：

| 优先级 | 选择策略 | 说明 | 示例 |
|--------|---------|------|------|
| 1 | **视觉关键词优先** | ID或名称包含"视觉"或"vision"（不区分大小写） | `doubao-seed-1-6-vision-250815` |
| 2 | **纯视觉模型优先** | type为`pure-vision`的模型 | 专属视觉模型 |
| 3 | **多模态模型次选** | type为`multimodal`的模型 | `doubao-seed-1-8-251228` |

### 自动切换流程

```
用户上传图片
    ↓
获取主模型（用户配置或默认纯视觉模型）
    ↓
尝试调用主模型
    ↓
成功？→ 返回结果 + 记录模型类型
    ↓ 失败
记录失败模型到失败列表
    ↓
智能选择备用模型：
  1. 优先选择包含"视觉"/"vision"关键词的模型
  2. 其次选择纯视觉模型（type='pure-vision'）
  3. 最后选择多模态模型（type='multimodal'）
  4. 排除已失败的模型
    ↓
尝试调用备用模型
    ↓
成功？→ 返回结果 + "备用模型切换成功" 日志
    ↓ 失败
记录失败模型，选择下一个备选
    ↓
所有模型都失败？→ 返回错误
```

## 配置方法

### 1. 环境变量配置

在 `.env.local` 文件中配置模型：

```bash
# 方式1：指定具体模型
VISION_MODEL=doubao-seed-1-6-vision-250815

# 方式2：留空，让系统自动选择最佳模型
# VISION_MODEL=
```

### 2. 可用的豆包视觉模型

| 模型ID | 类型 | 优先级 | 说明 |
|--------|------|--------|------|
| `doubao-seed-1-6-vision-250815` | 纯视觉 | 1 | 专为图像识别优化，推荐 |
| `doubao-seed-1-8-251228` | 多模态 | 2 | 支持视觉，推荐作为备用 |

**注意：**
- ❌ `doubao-seed-1-6-thinking-250715` - 纯文本模型，不能处理图片
- ❌ `doubao-seed-1-6-flash-250615` - 纯文本模型，不能处理图片
- ❌ `doubao-seed-1-6-lite-251015` - 纯文本模型，不能处理图片
- ❌ `doubao-seed-1-6-251015` - 通用对话模型，不支持视觉

只有真正支持视觉的模型才能被用作备用。

## 日志输出示例

### 成功使用纯视觉模型

```
============================================================
🎯 和弦识别任务启动
📐 图片尺寸: 1920 x 1080
📋 使用默认纯视觉模型: doubao-seed-1-6-vision-250815 (纯视觉模型)
🤖 主模型: doubao-seed-1-6-vision-250815
🤖 可用视觉模型: 3 个
============================================================
🚀 尝试主模型: doubao-seed-1-6-vision-250815 (优先级: 1)
🤖 调用主模型: doubao-seed-1-6-vision-250815
✅ 主模型调用成功: doubao-seed-1-6-vision-250815
🎯 实际使用的模型: doubao-seed-1-6-vision-250815
📊 模型类型: 纯视觉模型 ✓
```

### 自动切换到备用多模态模型

```
============================================================
🎯 和弦识别任务启动
📐 图片尺寸: 1920 x 1080
📋 使用默认纯视觉模型: doubao-seed-1-6-vision-250815 (纯视觉模型)
🤖 主模型: doubao-seed-1-6-vision-250815
🤖 可用视觉模型: 2 个
============================================================
🚀 尝试主模型: doubao-seed-1-6-vision-250815 (优先级: 1)
🤖 调用主模型: doubao-seed-1-6-vision-250815
❌ 主模型调用失败 (doubao-seed-1-6-vision-250815): Model not available
⚠️ 主模型 doubao-seed-1-6-vision-250815 调用失败: Model not available
🔍 智能选择备用模型（视觉关键词优先）: doubao-seed-1-8-251228 (多模态Agent, 优先级: 2)
🔄 尝试备用模型: doubao-seed-1-8-251228 (优先级: 2)
🤖 调用备用模型: doubao-seed-1-8-251228
✅ 备用模型调用成功: doubao-seed-1-8-251228
✅ 备用模型切换成功: doubao-seed-1-8-251228
🎯 实际使用的模型: doubao-seed-1-8-251228
📊 模型类型: 多模态模型
```

## 快速切换模型

### 场景1：不指定模型（推荐）

```bash
# .env.local
VISION_MODEL=
```

系统自动选择最佳纯视觉模型。

### 场景2：指定纯视觉模型

```bash
# .env.local
VISION_MODEL=doubao-seed-1-6-vision-250815
```

### 场景3：临时测试新模型

```bash
# 临时设置（不修改 .env.local）
export VISION_MODEL=doubao-seed-1-8-251228
```

### 场景4：部署环境切换

在 Vercel 部署时，直接在项目设置中添加环境变量：
- `VISION_MODEL`: 指定主模型（可选，留空则自动选择）

## 一致性保障

### 提示词设计
- 使用绝对像素坐标系统
- 明确的识别规则和返回格式
- 固定温度参数（temperature=0.2）

### 后处理机制
- OCR修正库校对升降号
- 去重算法（1%距离阈值）
- 异常值检测（±3标准差）

### 数据复用
- 同一图片只识别一次
- 调整字号/颜色时复用原数据
- 避免模型切换导致的差异

## 监控与调试

### 查看使用的模型

返回结果包含 `_modelUsed` 字段：

```json
{
  "key": "C",
  "centers": [...],
  "_modelUsed": "doubao-seed-1-6-vision-250815"
}
```

### 查看模型类型

日志中会显示模型类型：
- `📊 模型类型: 纯视觉模型 ✓` - 优先使用
- `📊 模型类型: 多模态模型` - 备用模型

### 错误处理

所有错误都会记录详细日志：
- 失败的模型列表
- 智能选择过程
- 最终失败原因（如果都失败）

## 注意事项

1. **优先纯视觉模型**：系统会自动优先选择纯视觉模型，识别准确性更高
2. **多级回退**：支持多级模型回退，确保服务连续性
3. **不要频繁切换**：每次切换都会重新识别，可能产生微小差异
4. **日志监控**：定期检查日志中的模型使用情况
5. **环境变量优先级**：.env.local > 自动选择 > 默认值

## 故障排查

### 问题：所有视觉模型都失败

**可能原因：**
- API密钥配置错误
- 网络连接问题
- 模型服务全部不可用

**解决方法：**
1. 检查 `.env.local` 配置
2. 查看 Docker/服务器日志
3. 验证 API 密钥是否有效
4. 联系技术支持

### 问题：模型切换后识别结果不一致

**可能原因：**
- 不同模型的识别能力差异
- 提示词对某些模型不够明确

**解决方法：**
1. 对比两组识别结果
2. 检查是否使用了相同优先级的模型（纯视觉 vs 多模态）
3. 使用数据复用机制（避免重复识别）
4. 根据实际情况微调提示词

## 最佳实践

1. **推荐配置**：不指定 `VISION_MODEL`，让系统自动选择最佳模型
2. **提前准备**：在模型停止服务前，系统会自动切换
3. **测试验证**：切换后先测试几张图片
4. **监控日志**：关注模型使用情况和错误率
5. **优先纯视觉**：尽量使用纯视觉模型，识别准确性更高
6. **渐进切换**：系统自动完成，无需手动干预

## 技术实现

### 模型配置

```typescript
interface VisionModelConfig {
  id: string;      // 模型ID
  name: string;    // 模型名称
  type: 'pure-vision' | 'multimodal';  // 模型类型
  priority: number; // 优先级
}

const AVAILABLE_VISION_MODELS: readonly VisionModelConfig[] = [
  {
    id: 'doubao-seed-1-6-vision-250815',
    name: '纯视觉模型',
    type: 'pure-vision',
    priority: 1,
  },
  {
    id: 'doubao-seed-1-8-251228',
    name: '多模态Agent',
    type: 'multimodal',
    priority: 2,
  },
  {
    id: 'doubao-seed-1-6-251015',
    name: '平衡性能',
    type: 'multimodal',
    priority: 2,
  },
];
```

### 模型优先级获取

```typescript
function getVisionModelPriority(modelId: string): number {
  const config = getModelConfig(modelId);
  if (config) {
    return config.priority;
  }
  return 3;  // 未知模型最低优先级
}
```

### 智能选择逻辑

1. 获取模型配置（通过 `getModelConfig()`）
2. 过滤掉已失败的模型
3. 按优先级分组候选模型
4. 优先选择优先级最高的模型
5. 排除同优先级中已失败的模型
6. 返回第一个可用的候选模型

### 优势

| 特性 | 旧方案（硬编码） | 新方案（配置化） |
|------|------------------|----------------|
| 可维护性 | 需要修改多处代码 | 只需修改配置列表 |
| 可扩展性 | 添加模型需要修改判断逻辑 | 添加模型只需添加配置项 |
| 类型安全 | 字符串匹配，容易出错 | TypeScript 类型检查 |
| 可读性 | 逻辑分散，难以理解 | 配置清晰，一目了然 |
