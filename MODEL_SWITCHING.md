# 模型切换指南

## 概述

系统支持通过环境变量配置视觉模型，并采用**智能模型选择机制**。当主模型不可用时，系统会自动从可用模型列表中选择最佳备用模型，优先选择**纯视觉模型**以保证识别准确性。

## 智能模型选择机制

### 模型优先级

系统根据模型类型自动排序：

| 优先级 | 模型类型 | 说明 | 示例 |
|--------|---------|------|------|
| 1 | 纯视觉模型 | 专为图像识别优化，识别准确性最高 | `doubao-seed-1-6-vision-250815` |
| 2 | 多模态模型 | 支持视觉，通用能力强 | `doubao-seed-1-8-251228`, `doubao-seed-1-6-251015` |

### 自动切换流程

```
用户上传图片
    ↓
获取主模型（用户配置或默认纯视觉模型）
    ↓
尝试调用主模型
    ↓
成功？→ 返回结果 + 记录模型类型
    ↓ 失败
记录失败模型到失败列表
    ↓
智能选择备用模型：
  1. 优先选择纯视觉模型（优先级1）
  2. 其次选择多模态模型（优先级2）
  3. 最后选择其他模型（优先级3）
  4. 排除已失败的模型
    ↓
尝试调用备用模型
    ↓
成功？→ 返回结果 + "备用模型切换成功" 日志
    ↓ 失败
记录失败模型，选择下一个备选
    ↓
所有模型都失败？→ 返回错误
```

## 配置方法

### 1. 环境变量配置

在 `.env.local` 文件中配置模型：

```bash
# 方式1：指定具体模型
VISION_MODEL=doubao-seed-1-6-vision-250815

# 方式2：留空，让系统自动选择最佳模型
# VISION_MODEL=
```

### 2. 可用的豆包视觉模型

| 模型ID | 类型 | 优先级 | 说明 |
|--------|------|--------|------|
| `doubao-seed-1-6-vision-250815` | 纯视觉 | 1 | 专为图像识别优化，推荐 |
| `doubao-seed-1-8-251228` | 多模态 | 2 | 支持视觉，推荐作为备用 |
| `doubao-seed-1-6-251015` | 平衡性能 | 2 | 支持视觉，可作为备选 |

**注意：**
- ❌ `doubao-seed-1-6-thinking-250715` - 纯文本模型，不能处理图片
- ❌ `doubao-seed-1-6-flash-250615` - 纯文本模型，不能处理图片
- ❌ `doubao-seed-1-6-lite-251015` - 纯文本模型，不能处理图片

只有真正支持视觉的模型才能被用作备用。

## 日志输出示例

### 成功使用纯视觉模型

```
============================================================
🎯 和弦识别任务启动
📐 图片尺寸: 1920 x 1080
🤖 主模型: doubao-seed-1-6-vision-250815
🤖 可用视觉模型: 3 个
============================================================
🚀 尝试主模型: doubao-seed-1-6-vision-250815 (优先级: 1)
🤖 调用主模型: doubao-seed-1-6-vision-250815
✅ 主模型调用成功: doubao-seed-1-6-vision-250815
🎯 实际使用的模型: doubao-seed-1-6-vision-250815
📊 模型类型: 纯视觉模型 ✓
```

### 自动切换到备用纯视觉模型

```
============================================================
🎯 和弦识别任务启动
📐 图片尺寸: 1920 x 1080
🤖 主模型: doubao-seed-1-6-vision-250815
🤖 可用视觉模型: 3 个
============================================================
🚀 尝试主模型: doubao-seed-1-6-vision-250815 (优先级: 1)
🤖 调用主模型: doubao-seed-1-6-vision-250815
❌ 主模型调用失败 (doubao-seed-1-6-vision-250815): Model not available
⚠️ 主模型 doubao-seed-1-6-vision-250815 调用失败: Model not available
🔍 智能选择备用模型: doubao-seed-1-8-251228 (优先级: 2)
🔄 尝试备用模型: doubao-seed-1-8-251228 (优先级: 2)
🤖 调用备用模型: doubao-seed-1-8-251228
✅ 备用模型调用成功: doubao-seed-1-8-251228
✅ 备用模型切换成功: doubao-seed-1-8-251228
🎯 实际使用的模型: doubao-seed-1-8-251228
📊 模型类型: 多模态模型
```

## 快速切换模型

### 场景1：不指定模型（推荐）

```bash
# .env.local
VISION_MODEL=
```

系统自动选择最佳纯视觉模型。

### 场景2：指定纯视觉模型

```bash
# .env.local
VISION_MODEL=doubao-seed-1-6-vision-250815
```

### 场景3：临时测试新模型

```bash
# 临时设置（不修改 .env.local）
export VISION_MODEL=doubao-seed-1-8-251228
```

### 场景4：部署环境切换

在 Vercel 部署时，直接在项目设置中添加环境变量：
- `VISION_MODEL`: 指定主模型（可选，留空则自动选择）

## 一致性保障

### 提示词设计
- 使用绝对像素坐标系统
- 明确的识别规则和返回格式
- 固定温度参数（temperature=0.2）

### 后处理机制
- OCR修正库校对升降号
- 去重算法（1%距离阈值）
- 异常值检测（±3标准差）

### 数据复用
- 同一图片只识别一次
- 调整字号/颜色时复用原数据
- 避免模型切换导致的差异

## 监控与调试

### 查看使用的模型

返回结果包含 `_modelUsed` 字段：

```json
{
  "key": "C",
  "centers": [...],
  "_modelUsed": "doubao-seed-1-6-vision-250815"
}
```

### 查看模型类型

日志中会显示模型类型：
- `📊 模型类型: 纯视觉模型 ✓` - 优先使用
- `📊 模型类型: 多模态模型` - 备用模型

### 错误处理

所有错误都会记录详细日志：
- 失败的模型列表
- 智能选择过程
- 最终失败原因（如果都失败）

## 注意事项

1. **优先纯视觉模型**：系统会自动优先选择纯视觉模型，识别准确性更高
2. **多级回退**：支持多级模型回退，确保服务连续性
3. **不要频繁切换**：每次切换都会重新识别，可能产生微小差异
4. **日志监控**：定期检查日志中的模型使用情况
5. **环境变量优先级**：.env.local > 自动选择 > 默认值

## 故障排查

### 问题：所有视觉模型都失败

**可能原因：**
- API密钥配置错误
- 网络连接问题
- 模型服务全部不可用

**解决方法：**
1. 检查 `.env.local` 配置
2. 查看 Docker/服务器日志
3. 验证 API 密钥是否有效
4. 联系技术支持

### 问题：模型切换后识别结果不一致

**可能原因：**
- 不同模型的识别能力差异
- 提示词对某些模型不够明确

**解决方法：**
1. 对比两组识别结果
2. 检查是否使用了相同优先级的模型（纯视觉 vs 多模态）
3. 使用数据复用机制（避免重复识别）
4. 根据实际情况微调提示词

## 最佳实践

1. **推荐配置**：不指定 `VISION_MODEL`，让系统自动选择最佳模型
2. **提前准备**：在模型停止服务前，系统会自动切换
3. **测试验证**：切换后先测试几张图片
4. **监控日志**：关注模型使用情况和错误率
5. **优先纯视觉**：尽量使用纯视觉模型，识别准确性更高
6. **渐进切换**：系统自动完成，无需手动干预

## 技术实现

### 模型优先级算法

```typescript
function getVisionModelPriority(modelId: string): number {
  if (modelId.includes('vision')) {
    return 1;  // 纯视觉模型
  }
  if (modelId.includes('-8-') || modelId.includes('agent')) {
    return 2;  // 多模态Agent模型
  }
  return 3;  // 其他模型
}
```

### 智能选择逻辑

1. 过滤掉已失败的模型
2. 按优先级分组候选模型
3. 优先选择优先级最高的模型
4. 排除同优先级中已失败的模型
5. 返回第一个可用的候选模型
